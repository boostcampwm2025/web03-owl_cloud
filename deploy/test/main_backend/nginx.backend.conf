# 동시에 처리 가능한 프로세스 수 설정 
worker_processes auto;

# 하나의 process는 4096개의 동시 연결이다.
events {
  worker_connections 4096;
}

http {

  upstream main_backend_app {
    # http 특성상 keep alive가 남아 있으면 성능적으로 좀 더 좋다. 
    keepalive 64;
    # backend 헬스 체크 추가 ( pool의 크기 )
    server main-backend:8080 max_fails=3 fail_timeout=10s;
  }

  # websocket용 upstream 추가
  upstream main_backend_ws {
    # 웹소켓은 이미 오랜 연결덕분에 딱히 keep alive가 필요한건 아니다.
    # 최대 3회 10초까지 기다려준다.
    server main-backend:8080 max_fails=3 fail_timeout=10s;
  }

  server {
    listen 80;
    server_name _;

    # 웹소켓 관련 추가
    location = /api/ws {
      return 301 /api/ws/;
    }

    location ^~ /api/ws/ {
      proxy_pass http://main_backend_ws;

      # websocket은 http1.1로 
      proxy_http_version 1.1;

      # 웹소켓 업그레이드 
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;

      # 연결 유지 시간을 1시간으로 잡는다 
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;

      # 실시간 성을 위해서 추가 ( 버퍼링 x )
      proxy_buffering off;
      
      # 업스트림 변경을 일으키지 않게 함 ( 현재는 필요 x - 추가 확장성을 고려 )
      proxy_next_upstream off;
    }

    # sse를 사용하는 경우 버퍼링을 꺼주고 오래 연결이 가능하도록 해주어야 한다. 
    location ^~ /api/sse/ {
      proxy_pass http://main_backend_app;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # buffering 꺼주기 -> 실시간으로 바로 보낼 수 있도록 하기 위함이다. 
      proxy_buffering off;
      proxy_cache off;
      add_header X-Accel-Buffering no;

      # 오랫동안 연결되도록 하기 1시간
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;

      # 응답을 메모리/디스크에 쌓지 않고 바로 전달하도록 한다. 
      proxy_request_buffering off;

      # 스트리밍에 경우 업스트림을 교체하지 않는다. 
      proxy_next_upstream off;

      # sse가 캐시되지 않도록 명시
      add_header Cache-Control "no-cache";

      # 압축 방지
      proxy_set_header Accept-Encoding "";
      gzip off;
    }

    # http 1.1을 그냥 사용
    location ^~ /api/ {
      proxy_pass http://main_backend_app;
      proxy_http_version 1.1;
      
      # keepalive도 고려하였음 
      proxy_set_header Connection "";
      proxy_set_header   Host $host;
      proxy_set_header   X-Real-IP $remote_addr;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;

      # body 사이즈는 10m 까지만 허용을 해준다. 
      client_max_body_size 10m;

      # 연결을 기다리는 시간은 5s 보내고 받는데는 각각 1m으로 설정한다.
      proxy_connect_timeout 5s;
      proxy_send_timeout 1m;
      proxy_read_timeout 1m;

      # 로드밸런서를 사용하게 되었을때 효과가 있다. -> 지금은 사실상 미미 ( 나중에 추가할 수도 있다. )
      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
    }

    # 규모가 커지면서 디버깅이 힘들어 질수도 있다. 그래서 이 설정을 넣음으로써 /api외에 다른 요청으로 생기는 에러는 여기서 잡을수가 있다.
    location / {
      return 404;
    }
  }
}