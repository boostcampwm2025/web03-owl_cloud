# 비슷한데 테스트 용도
server {
  listen 80;

  resolver 127.0.0.11 ipv6=off valid=10s;
  resolver_timeout 2s;
  proxy_http_version 1.1;

  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  set $main_backend_upstream http://main-backend-nginx;

  location = /api/ws {
    return 301 /api/ws/;
  } 

  # 웹소켓 연결과 관련
  location ^~ /api/ws/ {
    proxy_pass $main_backend_upstream;

    proxy_http_version 1.1;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    proxy_buffering off;
  }

  location ^~ /api/sse/ {
    proxy_pass $main_backend_upstream;

    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_buffering off;
    proxy_cache off;
    add_header X-Accel-Buffering no;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    proxy_request_buffering off;
    proxy_set_header Accept-Encoding "";
    gzip off;
    add_header Cache-Control "no-cache";

  }

  # main_backend 프록시 전달
  location /api/ { 
    proxy_pass $main_backend_upstream;

    proxy_set_header Connection "";

    client_max_body_size 10m;
    proxy_connect_timeout 5s;
    proxy_send_timeout 1m;
    proxy_read_timeout 1m;

  }

  # tool_backend 프록시 전달
  set $tool_backend_upstream http://tool-backend-nginx;
  location /tool/ { 
    proxy_pass $tool_backend_upstream;

    proxy_set_header Connection "";

    client_max_body_size 10m;
    proxy_connect_timeout 5s;
    proxy_send_timeout 1m;
    proxy_read_timeout 1m;

  }


  set $frontend_upstream http://frontend-nginx;

  location /_next/static/ {
    proxy_pass $frontend_upstream;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
    access_log off;
  }

  location ^~ /_next/image {
    proxy_pass $frontend_upstream;
    expires 1h;
    add_header Cache-Control "public" always;
  }  

  # 나머지는 frontend로 전달
  location / {
    proxy_pass $frontend_upstream;

    proxy_set_header Connection "";

    proxy_connect_timeout 3s;
    proxy_send_timeout 30s;
    proxy_read_timeout 60s;
  }

}