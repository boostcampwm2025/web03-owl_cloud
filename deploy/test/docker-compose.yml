services:

  # main_backend 서버 ( sfu로 인해서 하나만 사용할 계획이다. )
  main-backend:
    container_name: main-backend
    image: "${MAIN_BACKEND_IMG}:latest"
    env_file:
      - ./main_backend/.env.backend
    networks:
      - clobby-network
    # 서버가 죽으면 docker가 다시 켜주는 것을 말한다. ( 내가 멈춘거 제외 )
    restart: unless-stopped
    # 보안 주의 -> 이 포트는 docker에서 외부에 열어놓는거라서 nginx에 보호도 받지 못한다. -> 특정 컨테이너로 매핑
    ports:
      - "40000-40299:40000-40299/udp"
      - "40000-40299:40000-40299/tcp"

  # main_backend에 nginx ( 확장성으로 인해서 nginx를 나누기로 하였다. )
  main-backend-nginx:
    container_name: main-backend-nginx
    image: nginx:latest
    # 일단 설정 파일만
    volumes:
      - ./main_backend/nginx.backend.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - main-backend
    networks:
      - clobby-network
    restart: unless-stopped

  # tool_backend 서버
  tool-backend-app-1:
    container_name: tool-backend-app-1
    image: "${TOOL_BACKEND_IMG}:latest"
    env_file:
      - ./tool_backend/.env.backend
    networks:
      - clobby-network 
    restart: unless-stopped
    # 추후 로그 라던지 저장 하는 로직이 있다면 이용하면 좋을 것 같다. - volume추가 고민 있음

  tool-backend-app-2:
    container_name: tool-backend-app-2
    image: "${TOOL_BACKEND_IMG}:latest"
    env_file:
      - ./tool_backend/.env.backend
    networks:
      - clobby-network
    restart: unless-stopped

  tool-backend-app-3:
    container_name: tool-backend-app-3
    image: "${TOOL_BACKEND_IMG}:latest"
    env_file:
      - ./tool_backend/.env.backend
    networks:
      - clobby-network
    restart: unless-stopped

  # backend에 로드밸런싱을 담당할 nginx 파일
  tool-backend-nginx:
    container_name: tool-backend-nginx
    image: nginx:latest
    # 일단 설정 파일만
    volumes:
      - ./tool_backend/nginx.backend.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - tool-backend-app-1
      - tool-backend-app-2
      - tool-backend-app-3
    networks:
      - clobby-network
    restart: unless-stopped

  # frontend 빌드 
  frontend:
    container_name: frontend
    image: "${FRONTEND_IMG}:latest"
    # 환경 변수가 있다면
    # env_file:
    #   - ./.env.frontend
    # 기본적인 환경 설정은 여기서
    networks:
      - clobby-network
    restart: unless-stopped 

  # frontend도 nginx를 따로 둘 예정이다.
  frontend-nginx:
    container_name: frontend-nginx
    image: nginx:latest
    volumes:
      - ./frontend/nginx.frontend.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
    networks:
      - clobby-network
    restart: unless-stopped

  # 실제 서빙해주는 gateway 입니다 나중에 kubernetes로 변경을 한다면 이 부분은 변경되거나 사라집니다.
  gateway:
    image: nginx:latest
    container_name: gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.gateway.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/certbot/www:/var/www/certbot
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - main-backend-nginx
      - tool-backend-nginx
      - frontend-nginx
    networks:
      - clobby-network
    restart: unless-stopped 

# bridge 스타일로 각자가 독립적인 ip를 가지고 있음
networks:
  clobby-network:
    driver: bridge